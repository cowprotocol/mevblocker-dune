import { RpcBundle } from "../src/models";
import { convertBundle } from "../src/upload";

describe("testing bundle conversion", () => {
  test("succesfully decodes raw transaction", () => {
    const bundle: RpcBundle = {
      txs: [
        "0x02f8b10181db8459682f00850c9f5014d282be9894a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4880b844a9059cbb0000000000000000000000005408b27504dfcf7b0c3edf116e847aa19ce7f03c0000000000000000000000000000000000000000000000000000001e449a9400c080a049c0f50df4219481e031ac35816946daef9d08004f3324f7f46f6938488025aba02a4bda81f792bc5b7033804e39b7e55e619e56de1afcddd2ae4943ae5e7737c4",
      ],
      blockNumber: "0x1",
    };
    const result = convertBundle(bundle, "42", 69, "CoW Swap");
    expect(result).toStrictEqual({
      bundleId: "42",
      timestamp: 69,
      blockNumber: 1,
      transactions: [
        {
          nonce: 219,
          maxPriorityFeePerGas: "1500000000",
          maxFeePerGas: "54212433106",
          gasPrice: undefined,
          gasLimit: "48792",
          to: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
          from: "0xAb5801a7D398351b8bE11C439e05C5B3259aeC9B",
          value: "0",
          data: "0xa9059cbb0000000000000000000000005408b27504dfcf7b0c3edf116e847aa19ce7f03c0000000000000000000000000000000000000000000000000000001e449a9400",
          hash: "0x07151ed9706e4dffb31eaaac2ed1be5c6f05a9eef63c8f7c6ecad9ca8731aa22",
          mayRevert: false,
        },
      ],
      referrer: "CoW Swap",
    });
  });
  test("EIP 7702", () => {
    // https://etherscan.io/tx/0x87a41deccb73004da4615718ecce5f44f802f8c11125ff68c94a83f03b5583b6
    const bundle: RpcBundle = {
      txs: [
        "0x04f90b530182063284039b2820840a54abfc8306b6b294d8da6bf26964af9d7eed9e03e53415d37aa9604580b90a84abc5345e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b30000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae00000000000000000000000000000000000000000000000821abe2a7eb2af843000000000000000000000000000000000000000000000000000000000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000008842c57e884953490f1bf5d508a3dd017243a9f4baa9b66de1e6cad05f868d288fbf2469a9a00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000d8da6bf26964af9d7eed9e03e53415d37aa960450000000000000000000000000000000000000000000000018f019828a75e947a00000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000015616d626972652d657874656e73696f6e2d70726f640000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000003ef238c36035880efbdfa239d218186b79ad1d6f0000000000000000000000003ef238c36035880efbdfa239d218186b79ad1d6f000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb2000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb200000000000000000000000000000000000000000000000821abe2a7eb2af84300000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb2000000000000000000000000000000000000000000000000046c6de3bfb3219e00000000000000000000000000000000000000000000000000c7d72830e36048000000000000000000000000942f9ce5d9a33a82f88d233aeb3292e68023034800000000000000000000000000000000000000000000000000000000000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000081c779d9bfa94765c00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000404d33721a5000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb20000000000000000000000000000000000000000000000081c779d9bfa94765c0000000000000000000000002325e3f261cadb1c30cebf66c9f95f6fb016c0d40000000000000000000000000000000000000000000000000000000000000001000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000000000000000000000000000018f019828a75e947a000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003b0aa7d38bf3c103bf02d1de2e37568cbed3d6e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c46be92b89000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb20000000000000000000000000000000000000000000000081c779d9bfa94765c000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000018f4a2b554fe700000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000008101998eb451f6000201cf91b70017eabde82c9671e30e5502d312ea6eb201ffff002325e3f261cadb1c30cebf66c9f95f6fb016c0d4003b0aa7d38bf3c103bf02d1de2e37568cbed3d6e8000bb881c734c7a53101c02aaa39b223fe8d0a0e5c4f27ead9083c756cc201ffff02003b0aa7d38bf3c103bf02d1de2e37568cbed3d6e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0f85ef85c01945a7fc11397e9a8ad41bf10bf13f22b0a63f96f6d82063380a06005b4c91cb6b88b7bd72da03e6ad59ea9514d81859c2ec9d73cd5311081cb0fa05a31b9292de55ba27ed66b09e6d3e5c8d810c9a86ff5c8a01459f1d6e1f1957801a0385053ac64d4de0fd4d451e353da232b1606da62d8bf16d5aaa2ae4aefe0b840a004a94c9a385fa2586e7202431bb5e87a976600fd3d09a9833b70526ed643b7a1",
      ],
      blockNumber: "0x1",
    };
    const result = convertBundle(bundle, "42", 69, "CoW Swap");
    expect(result.transactions).toStrictEqual([
      {
        nonce: 1586,
        maxPriorityFeePerGas: "60500000",
        maxFeePerGas: "173321212",
        gasPrice: undefined,
        gasLimit: "439986",
        to: "0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045",
        from: "0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045",
        value: "0",
        data: "0xabc5345e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b30000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae00000000000000000000000000000000000000000000000821abe2a7eb2af843000000000000000000000000000000000000000000000000000000000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000008842c57e884953490f1bf5d508a3dd017243a9f4baa9b66de1e6cad05f868d288fbf2469a9a00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000d8da6bf26964af9d7eed9e03e53415d37aa960450000000000000000000000000000000000000000000000018f019828a75e947a00000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000015616d626972652d657874656e73696f6e2d70726f640000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000003ef238c36035880efbdfa239d218186b79ad1d6f0000000000000000000000003ef238c36035880efbdfa239d218186b79ad1d6f000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb2000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb200000000000000000000000000000000000000000000000821abe2a7eb2af84300000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb2000000000000000000000000000000000000000000000000046c6de3bfb3219e00000000000000000000000000000000000000000000000000c7d72830e36048000000000000000000000000942f9ce5d9a33a82f88d233aeb3292e68023034800000000000000000000000000000000000000000000000000000000000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000081c779d9bfa94765c00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000404d33721a5000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb20000000000000000000000000000000000000000000000081c779d9bfa94765c0000000000000000000000002325e3f261cadb1c30cebf66c9f95f6fb016c0d40000000000000000000000000000000000000000000000000000000000000001000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000000000000000000000000000018f019828a75e947a000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003b0aa7d38bf3c103bf02d1de2e37568cbed3d6e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c46be92b89000000000000000000000000cf91b70017eabde82c9671e30e5502d312ea6eb20000000000000000000000000000000000000000000000081c779d9bfa94765c000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000018f4a2b554fe700000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000008101998eb451f6000201cf91b70017eabde82c9671e30e5502d312ea6eb201ffff002325e3f261cadb1c30cebf66c9f95f6fb016c0d4003b0aa7d38bf3c103bf02d1de2e37568cbed3d6e8000bb881c734c7a53101c02aaa39b223fe8d0a0e5c4f27ead9083c756cc201ffff02003b0aa7d38bf3c103bf02d1de2e37568cbed3d6e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        hash: "0x87a41deccb73004da4615718ecce5f44f802f8c11125ff68c94a83f03b5583b6",
        mayRevert: false,
      },
    ]);
  });
  test("Blob TX", () => {
    // https://etherscan.io/tx/0x966159ef2394bfb253542d9796536a8e100a4ed4fc38730e815d0d00553eb026
    const bundle: RpcBundle = {
      txs: [
        "0x03f8d9018305dc2d8502553d11008506ffb7330082520894ff000000000000000000000000000000000004808080c0843b9aca00f863a0014938a5e53025da73cfdfa3e5fc7146f91149bd4cc4c939b8d85abe252e5834a0014f7b905818f7a88f96d0a51ee26a0acc97b73cad5745211b2506ec783aa5a1a00141813d099e92a0c319826d03241311b77940163d38ea4b876887ec5476244380a037a0565e4286cb808a2fe4aad557b78bd71399b87d91398019d0ef64713d86f0a02205b567c59252424479aedab71f6c69c670564daf39275d74f6ff2cf025856b",
      ],
      blockNumber: "0x1",
    };
    const result = convertBundle(bundle, "42", 69, "CoW Swap");
    expect(result.transactions).toStrictEqual([
      {
        nonce: 384045,
        maxPriorityFeePerGas: "10020000000",
        maxFeePerGas: "30060000000",
        gasPrice: undefined,
        gasLimit: "21000",
        to: "0xff00000000000000000000000000000000000480",
        from: "0xdBBE3D8c2d2b22A2611c5A94A9a12C2fCD49Eb29",
        value: "0",
        data: "0x",
        hash: "0x966159ef2394bfb253542d9796536a8e100a4ed4fc38730e815d0d00553eb026",
        mayRevert: false,
      },
    ]);
  });
});
